name: Run e2e tests
on: [pull_request]
concurrency: ci-${{ github.ref }}
jobs:
  test-kubernetes:
    runs-on: ubuntu-latest
    strategy:
      # The e2e tests are flaky and often one of the jobs fails. The default setting
      # causes all other currently running jobs to abort and all need to be restarted.
      fail-fast: false
      matrix:
        include:
          - k3s: v1.24
            k8s-test: v1.24.12
          - k3s: v1.25
            k8s-test: v1.25.8
          - k3s: v1.26
            k8s-test: v1.26.3
    name: k3s ${{ matrix.k3s }}
    steps:
    - uses: actions/setup-go@v2
      with:
        go-version: '1.19'
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: HCLOUD_TOKEN
      env:
        HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
        TTS_TOKEN: ${{ secrets.TTS_TOKEN }}
      run: |
        set -ueo pipefail
        if [[ "${HCLOUD_TOKEN:-}" != "" ]]; then
          echo "HCLOUD_TOKEN=$HCLOUD_TOKEN" >> "$GITHUB_ENV"
        elif [[ "${TTS_TOKEN:-}" != "" ]]; then
                  token="$(./script/get-token.sh)"
                  echo "::add-mask::$token"
                  echo "HCLOUD_TOKEN=$token" >> "$GITHUB_ENV"
        else
          echo "::error ::Couldn't determine HCLOUD_TOKEN. Check that repository secrets are setup correctly."
          exit 1
        fi

    - uses: 3bit/setup-hcloud@v2
    - uses: yokawasa/action-setup-kube-tools@v0.9.2
      with:
        setup-tools: |
          helm
          kubectl
          skaffold
        helm: v3.11.2
        kubectl: v1.26.3
        skaffold: v2.3.0

    - name: Run tests
      env:
        K3S_CHANNEL: ${{ matrix.k3s }}
        K8S_TEST_VERSION: ${{ matrix.k8s-test }}
        SCOPE: gha-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.k3s }}
      run: |
        curl -sLS https://get.k3sup.dev | sh

        trap "hack/dev-down.sh; ./script/delete-token.sh $HCLOUD_TOKEN" EXIT
        source <(hack/dev-up.sh)

        skaffold build --tag="e2e-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}"
        tag=$(skaffold build --tag="e2e-${GITHUB_RUN_ID}-${GITHUB_RUN_NUMBER}" --quiet --output="{{ (index .Builds 0).Tag }}")
        skaffold deploy --images=hetznercloud/hcloud-csi-driver=$tag

        test/e2e/kubernetes/run-e2e-tests.sh
